# 2026-02-06 工作日誌

## 商城系統測試環境部署

### 已完成
- Docker 29.2.1 安裝成功
- 基礎設施容器啟動：
  - ✅ MySQL 5.7 (mall 數據庫已導入)
  - ✅ Redis 7
  - ✅ RabbitMQ 3.10
  - ⏸️ Elasticsearch 暫時跳過（JDK cgroup v2 兼容性問題）
- JDK 8 (1.8.0_482) 安裝成功
- Maven 3.8.7 安裝成功
- mall 源碼複製到 `/home/ubuntu/general-mall/mall`

### 進行中
- Maven 構建 mall-admin 模組（正在下載依賴）
- 構建命令：`mvn clean package -DskipTests -pl mall-common,mall-mbg,mall-security,mall-admin -am`
- 進程會話：`mellow-trail` (pid 15805)

### 待完成
- 啟動 mall-admin 後端服務
- 構建並啟動 mall-portal
- 部署前端管理介面
- 配置 Nginx 反向代理

### 目錄結構
```
/home/ubuntu/general-mall/
├── docker-compose.yml
├── sql/
│   └── mall.sql
└── mall/          # mall 源碼
    ├── mall-admin
    ├── mall-portal
    └── ...
```

### 服務端口
- MySQL: 3306
- Redis: 6379
- RabbitMQ: 5672 (AMQP), 15672 (管理介面)
- mall-admin: 8080 (待啟動)

### 已知問題
- Elasticsearch 7.17.3 無法在此環境運行（cgroup v2 與 JDK 不兼容）
- 搜尋功能暫時不可用，後續需解決或使用替代方案

---

## GitHub 源碼上傳

### 已上傳倉庫
| 倉庫 | 說明 | 檔案數 |
|------|------|--------|
| mall-backend | 後端 Java | 719 |
| mall-admin-web | 後台前端 | 235 |
| mall-app-web | 前台 H5 | 155 |
| mall-deploy | 部署配置 | 3 |

### 倉庫地址
- https://github.com/ArJay951/mall-backend
- https://github.com/ArJay951/mall-admin-web
- https://github.com/ArJay951/mall-app-web
- https://github.com/ArJay951/mall-deploy

### 已更新 Skill 文件
- `general-mall/SKILL.md` - 添加 GitHub 倉庫與測試環境資訊
- `entertainment-mall/SKILL.md` - 添加基礎源碼參考

## 資料庫繁體中文化

- 使用 OpenCC 將 `mall.sql` 從簡體轉換為台灣繁體 (s2twp)
- 繁體 SQL 存放：`/home/ubuntu/general-mall/document/sql/mall.sql`
- 已重新導入資料庫，所有商品、分類、品牌名稱皆為繁體中文

## Source IP 白名單功能（已完成）

### 設計決策
- **使用 IP 而非 Domain**：Domain 可能被竄改，後端自動取得 Remote IP 更安全
- **非白名單 → 拒絕**：硬性阻擋，非僅記錄
- **支援 CIDR**：如 `192.168.0.0/24` 可匹配整個網段

### 資料庫結構
```sql
CREATE TABLE oms_order_source (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    name VARCHAR(100) NOT NULL COMMENT '來源名稱',
    ip_whitelist TEXT COMMENT 'IP 白名單，逗號分隔，支援 CIDR',
    status INT DEFAULT 1 COMMENT '狀態：0=停用, 1=啟用',
    create_time DATETIME,
    update_time DATETIME
);
ALTER TABLE oms_order ADD source_ip VARCHAR(45) COMMENT '來源 IP';
```

### 核心邏輯
1. 從 `X-Forwarded-For` 或 `RemoteAddr` 取得客戶端 IP
2. 查詢 `oms_order_source` 表，找 `status=1` 且 IP 在白名單內的記錄
3. 若無匹配 → 返回錯誤 "來源 IP 未授權"
4. 若匹配 → 記錄 `source_ip` 和 `source_name`

### 測試指令
```bash
# 新增測試來源
INSERT INTO oms_order_source (name, ip_whitelist, status, create_time) 
VALUES ('本地測試', '127.0.0.1,192.168.0.0/24', 1, NOW());

# 測試 API（需從白名單 IP 發起）
curl -X POST http://localhost:8085/order/auto-generate/collect \
  -H "Content-Type: application/json" \
  -d '{"amount": 1000, "name": "測試", "phone": "0912345678"}'
```

## Pay Order → Return Apply 整合（進行中）

### 需求確認
- 代付訂單生成後，自動建立 `oms_order_return_apply` 記錄
- `order_id` = 代付訂單自己的 ID（不是代收訂單）
- 商品分配策略：貪婪法，優先使用高單價商品
- `status = 0`（待審核）
- `reason` = "自動生成：代付訂單配對"

### 實作進度
- [x] 添加 `OmsOrderReturnApplyMapper` import
- [x] 添加 `@Autowired private OmsOrderReturnApplyMapper returnApplyMapper`
- [ ] 實作商品分配邏輯（貪婪法）
- [ ] 建立 `OmsOrderReturnApply` 記錄
- [ ] 測試完整流程

### 修改檔案
- `/home/ubuntu/general-mall/mall/mall-portal/src/main/java/com/macro/mall/portal/service/impl/AutoOrderServiceImpl.java`

---

## 關鍵資訊備忘

### 測試環境
- **伺服器**: 52.76.231.27
- **後台**: http://52.76.231.27/admin/ (admin/macro123)
- **前台**: http://52.76.231.27/web/
- **後端 API**: 
  - mall-admin: 8080
  - mall-portal: 8085

### 服務管理
```bash
sudo systemctl restart mall-admin mall-portal
sudo systemctl status mall-admin mall-portal
```

### 資料庫連線
```bash
docker exec -it general-mall-mysql-1 mysql -uroot -proot mall
```

### 開發工作流程（舊 - systemd）
1. 編輯 `/home/ubuntu/general-mall/mall/...`
2. 重建：`cd /home/ubuntu/general-mall/mall && mvn clean package -DskipTests -pl mall-portal -am`
3. 複製 JAR：`sudo cp mall-portal/target/mall-portal-1.0-SNAPSHOT.jar /opt/mall/mall-portal.jar`
4. 重啟：`sudo systemctl restart mall-portal`

---

## 後續進展（當日晚間）

### Docker Compose 完整部署（已完成）
- **架構改變**：從 systemd 服務改為全 Docker Compose
- **容器化服務**：MySQL, Redis, RabbitMQ, ES, MongoDB, mall-admin, mall-portal
- **前端部署**：admin-web 和 app-web 通過 Nginx 靜態文件
- **Docker 建置修正**：
  - pom.xml: `http://192.168.3.101:2375` → `unix:///var/run/docker.sock`
  - 基礎映像: `openjdk:8` → `eclipse-temurin:8-jre`

### 部署腳本
- **檔案**: `/home/ubuntu/general-mall/deploy.sh`
- **用法**: `bash deploy.sh [backend|admin|web|all|db]`
- 支援增量部署，自動處理構建和容器重建

### 監控系統
- **健康檢查腳本**: `/home/ubuntu/general-mall/health_check.sh`
- **Cron Job ID**: `017ac75c-8511-402e-9c4c-880001a81af5`
- **頻率**: 每 5 分鐘
- **通知**: Telegram (異常時才通知)

### 資料庫優化
- **Charset 修正**: `utf8` → `utf8mb4`, `utf8_general_ci` → `utf8mb4_general_ci`
- **Initial SQL 擴展**: 添加 `oms_order_source` 表和「風險控管」選單
- **選單結構**: 風險控管 > 訂單來源管理

### 前端修正
- **Typo 修正**: `prefrenceArea.js` → `preferenceArea.js`（已提交 git）

### 預算文件
- **報價單**: `/home/ubuntu/.openclaw/workspace/商城專案報價單.md`
- **通用商城**: NT$40,000
- **娛樂城商城**: NT$244,000
- **合計優惠價**: NT$270,000

### 延後項目
- **Pay Order → Return Apply**: 阿杰決定暫不實作（"先不用"）
- **娛樂城 API**: 等待娛樂城方提供 API 文檔

### 當前服務狀態
```bash
# 服務管理（新方式）
cd /home/ubuntu/general-mall && docker compose up -d
docker compose ps

# 完整重建
bash /home/ubuntu/general-mall/deploy.sh all
```

### 環境變數設計
- 所有配置使用 `${VAR:default}` 模式
- 支援 Docker ↔ RDS 快速切換
- `.env.example` 提供範本

