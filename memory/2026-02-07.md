# 2026-02-07 工作日誌

## Auto-Order API 來源 IP 白名單功能

### 完成項目
1. **資料庫**
   - 新增 `oms_order_source` 表（來源管理）
   - `oms_order` 新增 `source_ip`, `source_name` 欄位

2. **後端 mall-portal**
   - IP 自動取得（X-Forwarded-For → X-Real-IP → RemoteAddr）
   - 白名單驗證（支援 CIDR 格式如 `192.168.0.0/24`）
   - 不在白名單 → 拒絕請求

3. **後端 mall-admin**
   - 來源管理 CRUD API (`/orderSource/*`)

4. **前端**
   - 新增「風險控管 → 來源管理」頁面
   - 路由設定 `alwaysShow: true` 避免單一子菜單折疊

### 權限設定（新增頁面必做）
- `ums_menu` 新增菜單
- `ums_role_menu_relation` 分配給超級管理員 (id=5)
- `ums_resource` 新增 API 資源
- `ums_role_resource_relation` 分配資源權限
- 清除 Redis 緩存 + 重啟服務

## 代付訂單 → 退貨申請

修改 `AutoOrderServiceImpl.generatePayOrder()`：
- 建立訂單後自動建立 `oms_order_return_apply` 記錄
- 狀態設為 0（待處理）
- 原因填入「代付退款」
- 顯示在「退貨申請處理」頁面

## 訂單/退貨查詢新增來源篩選

1. **訂單列表**
   - `OmsOrderQueryParam` 新增 `sourceName`
   - `OmsOrderDao.xml` 新增查詢條件
   - 前端新增「來源」下拉選單 + 表格欄位

2. **退貨申請列表**
   - `OmsReturnApplyQueryParam` 新增 `sourceName`
   - `OmsOrderReturnApplyDao.xml` LEFT JOIN 訂單表查詢
   - 前端新增「來源」下拉選單

## 開發規範確認

1. **語言**：兩個專案皆使用繁體中文
2. **流程**：需求 → 記錄 → 確認 → 開發
3. **新增頁面檢查清單**：已記錄到 SKILL.md

## 測試數據

來源管理表已有：
- 測試來源 (127.0.0.1, ::1, 172.31.0.0/16)
- Casino-A (203.1.2.0/24)
