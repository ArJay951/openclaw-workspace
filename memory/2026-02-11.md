# 2026-02-11 (二)

## Auto-Order API 修正與測試

### 問題修正
1. **算法修正**：從「向下湊」改為「向上湊」
   - 舊：商品總價 ≤ 目標金額（錯誤）
   - 新：商品總價 ≥ 目標金額（正確）
   - 折扣 = 商品總價 - 目標金額
   - **訂單金額 = 傳入金額（固定）**


### 測試結果
- 26 個金額全部通過（3,000 ~ 100,000）
- 代收 + 代付 共 52 筆測試 ✅

### Git Commits
| Repo | Commit | 說明 |
|------|--------|------|
| mall-backend | e85d355 → fc5ad44 | 修正算法、清理代碼 |
| mall-deploy | 0904370 | 新增 Postman Collection |

### Postman Collection
- 檔案：`/home/ubuntu/mall-deploy/Auto-Order-API.postman_collection.json`
- baseUrl：`http://dev.homely-go.com/portal`

### IP 白名單
已添加伺服器 IP (52.76.231.27) 到白名單：
```sql
SELECT * FROM oms_order_source;
```

### 部署指令
```bash
bash /home/ubuntu/general-mall/deploy.sh backend
```

## Skill 更新
- 更新 `skills/general-mall/references/auto-order-api.md`
- 更新 `skills/general-mall/SKILL.md`

---

## 後續修正

### 產品多樣性算法
- 每輪每產品最多選 7-12 件
- 大金額訂單分多輪選擇，避免單一產品過多

### 代收訂單狀態修正
- status=1 (已支付/待發貨)，非 status=0 (待付款)
- payType=2, paymentTime=當前時間

### API 路徑調整
- 代收：`/order/auto-generate/collect`
- 代付：`/order/auto-generate/pay`
- 分開端點，不用 type 參數

### 折扣重複扣除 Bug 修正 ⚠️
**根本原因**：前端公式 `payAmount + freightAmount - discountAmount` 會再扣一次折扣

**修正方案**（在 `AutoOrderServiceImpl.java`）：
- `totalAmount = targetAmount`（輸入金額）
- `discountAmount = 0`（不再設折扣）
- 前端顯示金額 = 後端金額（一致）

### Git 最終 Commit
- mall-backend: `f6bcf5d`

### 當前產品
- 26 個產品，價格範圍 20-850 TWD
- kunweico.com 爬取因 Vue.js SPA 需 Puppeteer，暫擱置
