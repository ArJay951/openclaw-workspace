# 2026-02-11 (二)

## Auto-Order API 修正與測試

### 問題修正
1. **算法修正**：從「向下湊」改為「向上湊」
   - 舊：商品總價 ≤ 目標金額（錯誤）
   - 新：商品總價 ≥ 目標金額（正確）
   - 折扣 = 商品總價 - 目標金額
   - **訂單金額 = 傳入金額（固定）**


### 測試結果
- 26 個金額全部通過（3,000 ~ 100,000）
- 代收 + 代付 共 52 筆測試 ✅

### Git Commits
| Repo | Commit | 說明 |
|------|--------|------|
| mall-backend | e85d355 → fc5ad44 | 修正算法、清理代碼 |
| mall-deploy | 0904370 | 新增 Postman Collection |

### Postman Collection
- 檔案：`/home/ubuntu/mall-deploy/Auto-Order-API.postman_collection.json`
- baseUrl：`http://dev.homely-go.com/portal`

### IP 白名單
已添加伺服器 IP (52.76.231.27) 到白名單：
```sql
SELECT * FROM oms_order_source;
```

### 部署指令
```bash
bash /home/ubuntu/general-mall/deploy.sh backend
```

## Skill 更新
- 更新 `skills/general-mall/references/auto-order-api.md`
- 更新 `skills/general-mall/SKILL.md`

---

## 後續修正

### 產品多樣性算法
- 每輪每產品最多選 7-12 件
- 大金額訂單分多輪選擇，避免單一產品過多

### 代收訂單狀態修正
- status=1 (已支付/待發貨)，非 status=0 (待付款)
- payType=2, paymentTime=當前時間

### API 路徑調整
- 代收：`/order/auto-generate/collect`
- 代付：`/order/auto-generate/pay`
- 分開端點，不用 type 參數

### 折扣重複扣除 Bug 修正 ⚠️
**根本原因**：前端公式 `payAmount + freightAmount - discountAmount` 會再扣一次折扣

**修正方案**（在 `AutoOrderServiceImpl.java`）：
- `totalAmount = targetAmount`（輸入金額）
- `discountAmount = 0`（不再設折扣）
- 前端顯示金額 = 後端金額（一致）

### Git 最終 Commit
- mall-backend: `f6bcf5d`

### 當前產品
- 26 個產品，價格範圍 20-850 TWD
- kunweico.com 爬取因 Vue.js SPA 需 Puppeteer，暫擱置

---

## Entertainment Mall 環境準備

### 隔離策略
| 資源 | General Mall | Entertainment Mall |
|------|-------------|-------------------|
| 目錄 | `/home/ubuntu/general-mall/` | `/home/ubuntu/entertainment-mall/` |
| Admin Port | 8080 | 8090 |
| Portal Port | 8085 | 8095 |
| MySQL DB | `mall` | `ent_mall` |
| Redis Prefix | `mall:` | `ent:` |
| Docker Prefix | `mall-*` | `ent-*` |

### GitHub Repos 建立
- ✅ `ent-mall-backend` - 已推送 (718 files)
- ⏳ `ent-mall-admin-web` - Repo 已建立，待推送

### 目錄結構
- 後端: `/home/ubuntu/entertainment-mall` (從 mall-source 複製)
- 前端: `/home/ubuntu/ent-mall-admin-web` (從 macrozheng/mall-admin-web 複製)
- 原始碼來源: `/home/ubuntu/mall-source` (乾淨版 macrozheng/mall)

### 關鍵決策
- 使用新空 repo，不是 fork
- 從 `mall-source` 複製（原始版），不從 `general-mall`（已客製化）
- GitHub API 建立 repo（gh CLI 不可用）

### 下一步
1. 推送 `ent-mall-admin-web` 到 GitHub
2. 配置 ports、DB、Redis prefix
3. 建立獨立 docker-compose.yml
4. 等待 Casino API 文件

---

## REQ-001: 後台金額改為點數 ✅

### 完成項目
1. **全局過濾器** (`src/main.js`)
   - `formatPoints`: 數字 → "X,XXX 點"
   - `pointsNumber`: 數字 → "X,XXX"

2. **訂單模組** (`src/views/oms/`)
   - 訂單列表：訂單金額 → 訂單點數
   - 訂單詳情：價格、小計、合計、費用資訊全部改為點數
   - 退貨申請：退款金額 → 退款點數

3. **商品模組** (`src/views/pms/`)
   - 商品列表：價格/貨號 → 點數/貨號
   - 商品詳情：商品售價 → 商品點數，市場價 → 原始點數
   - 批量編輯：銷售價格 → 銷售點數

4. **優惠券模組** (`src/views/sms/coupon/`)
   - 列表：金額元 → 點數點
   - 詳情：面額、使用門檻 元 → 點
   - 歷史：同上

### Git Commit
- `0cb579e`: feat(REQ-001): 金額顯示改為點數

---

## REQ-002: App 前端改版 (進行中)

### 首頁設計完成
- `/home/ubuntu/ent-mall-app-web/pages/index/index.vue` 已改版
- 深色主題 (紫藍漸層 #1a1a2e, #252542, #667eea)
- 參考 lhshop.online 風格

### uni-app H5 構建問題 ⚠️

**嘗試過的方案：**
1. Node.js 22 + npm install → `this.getOptions is not a function`
2. Docker + Node.js 16 → 同上錯誤
3. Docker + Node.js 14 → `babel-loader` 使用 `??=` 語法不支援
4. Docker + Node.js 16 + babel-loader@8.2.5 → 進行中

**根本原因：**
- `@dcloudio` 套件版本 (2.0.2-*) 與 webpack/loader-utils 版本衝突
- 新版 babel-loader (8.4.1) 使用 ES2021 語法，舊 Node 不支援
- 舊版套件在新 Node.js 中有相容性問題

**建議方案：**
1. 使用 HBuilderX IDE 構建（最穩定）
2. 找完全相容的依賴版本組合
3. 考慮升級到 uni-app Vue 3 版本

### 檔案位置
- 原始備份: `/home/ubuntu/ent-mall-app-web/pages/index/index.vue.bak`
- src 目錄: `/home/ubuntu/ent-mall-app-web/src/` (複製自根目錄)
- Dockerfile: `/home/ubuntu/ent-mall-app-web/Dockerfile.build`

---

## REQ-002: App 前端改版 ✅ 完成

### 已改造頁面 (15 個)
| 頁面 | 檔案 | 說明 |
|------|------|------|
| 首頁 | index/index.vue | 熱門商品、公告、快捷入口 |
| 分類頁 | category/category.vue | 左選單 + 右分類網格 |
| 商品列表 | product/list.vue | 篩選欄 + 雙列卡片 |
| 商品詳情 | product/product.vue | 輪播圖 + 規格選擇 + 優惠券 |
| 購物車 | cart/cart.vue | 數量控制 + 結算欄 |
| 登入 | public/login.vue | 漸層背景 + 表單卡片 |
| 註冊 | public/register.vue | 驗證碼 + 協議 |
| 用戶中心 | user/user.vue | 積分區 + 訂單區 |
| 訂單列表 | order/order.vue | 標籤欄 + 訂單卡片 |
| 創建訂單 | order/createOrder.vue | 地址選擇 + 價格明細 |
| 支付頁 | money/pay.vue | 支付方式選擇 |
| 支付成功 | money/paySuccess.vue | 成功提示 |
| 地址列表 | address/address.vue | 地址卡片 |
| 地址編輯 | address/addressManage.vue | 地區選擇器 |
| 設置頁 | set/set.vue | 分組選單 |

### 設計規範
- 背景: `#1a1a2e` → `#16213e` 漸層
- 卡片: `#252542`
- 主色: `#667eea` → `#764ba2`
- 點數: 金色 `#ffd700`
- 警告: 紅色 `#ff6b6b`

### Git Commits
- `80c3973`: 首頁、分類、列表、購物車、用戶
- `00522ba`: 詳情、登入、訂單、支付、地址、設置

### 下一步
使用 HBuilderX 構建 H5，上傳到 nginx

---

## 轉換為純 Vue 2 + Vant 2 專案 ✅

### 原因
uni-app CLI 構建問題無法解決 (Node版本/依賴衝突)，且只需 H5 不需原生 App

### 架構
- **框架**: Vue 2 + Vant 2 + Vue Router + Vuex + Axios
- **路徑**: `/home/ubuntu/ent-mall-app-web/src/` (新Vue專案)
- **備份**: `/home/ubuntu/ent-mall-app-web-uniapp/` (舊uni-app)

### 專案結構
```
src/
├── main.js          # Vant 組件導入
├── App.vue          # 深色主題 TabBar
├── router/index.js  # 所有路由 + auth guard
├── store/index.js   # token/user/cart state
├── utils/request.js # axios with auth
├── api/             # home, product, cart, member, order, address, coupon, collection
└── views/
    └── home/index.vue  # 首頁 (已完成)
```

### 子代理任務
- 生成剩餘 15 個頁面 (category, product list/detail, cart, user, login/register, order list/create/detail, pay/success, address list/edit, settings)
- Agent key: `agent:main:subagent:282a0732-f9cf-48d7-a4aa-ba53d643c9a9`

### Nginx 配置
- `/etc/nginx/sites-available/ent-mall`: `/` → dist/, `/portal-api/` → localhost:8095

### 待完成
1. ~~確認子代理完成頁面生成~~ ✅
2. ~~`npm run build` 生成 dist/~~ ✅
3. 驗證 ent.homely-go.com 功能測試
4. 推送到 GitHub

---

## 2026-02-12 RWD + 配色調整

### RWD 響應式重構 ✅
- 子代理重寫所有 17 個頁面，支援 RWD
- Desktop(≥1200px): 頂部完整導航 + 4列商品，無 tabbar
- Tablet(768-1199px): 3列商品
- Mobile(<768px): 底部 tabbar + 簡潔 header + 2列商品
- 參考 lhshop.online 佈局（桌面版和手機版不同）

### 配色調整
1. **第一版**: 深色紫藍 → 淺色紅色（貼近 lhshop.online）
2. **第二版**: 阿杰反饋「太紅太突兀」，調整為：
   - 搜索框：灰色邊框（非紅色）
   - 分類導航：白底（非紅色漸層）
   - 手機 header：白色（非紅色）
   - Logo：深色文字（非紅色漸層）
   - Tabbar active：深色 #333（非紅色）
   - 輪播圖：藍紫/綠漸層（非紅色）
   - 價格和按鈕保留淡紅色點綴

### 阿杰設計偏好 ⚠️
- **不喜歡大面積強調色**，偏好低調柔和
- 強調色只用在小元素（價格、按鈕）
- 大區塊用白色/灰色/中性色
