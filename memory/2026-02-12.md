# 2026-02-12

## 工作流改造 ✅

### 新模式：主管 + 員工
- Main Agent：聊天、收斂需求、寫工單、指派 sub、驗收
- Sub Agent：coding、QA、build、deploy
- 任務工單：`tasks/TASK-XXX/` 含 TASK.md + CONTEXT.md
- 完成後歸檔到 `tasks/archive/`
- 已更新 AGENTS.md、精簡 MEMORY.md

## Entertainment Mall 前端調整 ✅

### RWD 響應式重構
- 所有 17 個頁面支援 RWD
- Desktop(≥1200px): 頂部完整導航 + 4列商品，無 tabbar
- Tablet(768-1199px): 3列商品
- Mobile(<768px): 底部 tabbar + 簡潔 header + 2列商品

### 配色調整
- 深色紫藍 → 淺色紅色 → **柔和淺色**（阿杰嫌紅色太突兀）
- 大面積：白色/灰色/中性色
- 紅色只留在價格數字和小按鈕
- 導航/header/tabbar 都改中性色
- 輪播圖用藍紫/綠漸層

### Bug 修復
- 桌面版 tab active 狀態
- 全部分類 dropdown 點擊（mouseleave 事件問題，改用 wrapper 包裹）
- 商品列表支援 type=new/hot/sid + watch 路由變化
- 灰底跟隨 active tab

## SaaS 多租戶改造 ✅ (TASK-001)

### 完成內容
- Master DB `ent_master` + tenant 表
- 動態數據源 `AbstractRoutingDataSource`（根據 domain 切換 DB）
- TenantContext (ThreadLocal) + TenantInterceptor (從 Host header 解析)
- TenantRegistry（從 master DB 載入租戶清單）
- TenantDataSourceConfig（Druid 連接池相容）
- Redis key 租戶前綴隔離 (TenantKeySerializer)
- Portal + Admin 都有 `/tenant/info` API
- 前台 App.vue 動態載入租戶品牌
- 後台 App.vue 動態載入租戶名稱
- 租戶開通腳本 `scripts/create-tenant.sh`
- Nginx wildcard 配置 `ent-saas`

### 部署結果
- ent.homely-go.com 作為第一個租戶正常運行
- `Dynamic tenant datasource initialized with 1 tenants`
- 所有 API 正常回應
- 後端 mvn build ✅, 前台 npm build ✅, 後台 npm build ✅

### TASK-002: 資安修復 ✅
修復 7 項資安風險：
1. `/tenant/refresh` Portal 移除、Admin 需認證
2. 未知 domain → 403（關閉 fallback，只允許 localhost）
3. 租戶獨立 DB 帳號 `ent_user`（非 root）
4. MySQL root 限制 IP（root@172.18.% + localhost，刪除 root@% 和 reader@%）
5. Actuator Nginx 層擋 403
6. Nginx wildcard 不影響 dev.homely-go.com（精確匹配優先）
7. tenant/info 不回傳 tenantCode

### TASK-003: 邏輯問題修復 ✅
修復 7 個多租戶邏輯問題：
1. DataSource 動態新增（refreshTenants 自動建立新租戶連線池，不需重啟）
2. JWT Token 綁定租戶（token 含 tenant claim，跨租戶 token 回 401，舊 token 相容）
3. RabbitMQ 隔離（消息帶 tenantCode header）
4. MongoDB 隔離（document 加 tenantCode 欄位 + 查詢過濾）
5. 定時任務遍歷所有租戶（OrderTimeOutCancelTask 改造，仍未啟用）
6. Elasticsearch 預備（EsProduct 加 tenantCode，mall-search 未啟用）
7. Redis Hash Key 用 TenantKeySerializer

### SaaS 完成度
- Phase 1 核心 ✅
- 資安修復 ✅
- 邏輯隔離 ✅
- 待做：實際開通第二個租戶測試、計費系統、超級管理後台

### 架構
```
Master DB (ent_master) → tenant 表
    ↓
TenantInterceptor → 從 domain 解析 tenant_code
    ↓
TenantContext (ThreadLocal) → 存當前租戶
    ↓
TenantDataSource (AbstractRoutingDataSource) → 切換到對應 DB
```

## General Mall（支付商城）新需求 — 進行中

### 背景
回到 dev.homely-go.com 的代收代付 Auto-Order API 改造

### 現狀架構
- API: `/order/auto-generate/collect` (代收), `/order/auto-generate/pay` (代付)
- 請求參數: name, phone, amount
- 認證: IP 白名單 (`oms_order_source` 表，含 ipWhitelist 欄位)
- 來源: 由 IP 匹配自動填入 sourceName
- 路徑: `/home/ubuntu/general-mall/mall/`
- 相關檔案:
  - `mall-portal/.../AutoOrderController.java`
  - `mall-portal/.../AutoOrderRequest.java`
  - `mall-portal/.../AutoOrderServiceImpl.java`
  - `mall-portal/.../OrderSourceServiceImpl.java`
  - `mall-mbg/.../OmsOrderSource.java`
  - `mall-admin/.../OmsOrderSourceController.java`

### 新需求（待確認）
1. **API 參數改為**: 員工ID、設備號、金額（移除 name/phone）
2. **來源規則改為記錄用途**: 員工ID+設備號判斷來源，只記錄不阻擋（移除 IP 白名單驗證）
3. **認證改 Token**: 帶 token 才能打 API
4. **新增「廠商」角色**: 廠商登入後台只能看自己來源的訂單

### 待阿杰確認
1. Token 機制 — API Key per 廠商 or JWT？
2. 員工ID+設備號 → 來源的對應關係怎麼建？
3. 廠商後台 — 現有 admin 加權限 or 獨立入口？

## 其他完成事項

### SaaS 三個 repo 已 push GitHub ✅
- ent-mall-backend: `0a28d10` (master)
- ent-mall-admin-web: `340843e` (master)
- ent-mall-app-web: `81bb48e` (master)
- TASK-001/002/003 已歸檔到 `tasks/archive/`

## General Mall 代收代付改造

### TASK-004: Auto-Order API 改造 ✅ (commit `e21314a`)
- IP 白名單 → Token 認證 (`X-Api-Token` header)
- 請求參數: employeeId + deviceId + amount（移除 name/phone）
- 員工/設備歸屬驗證 + Redis 緩存
- 後台: 來源管理加 token 生成/重發、設備 CRUD
- 廠商角色: admin 帳號綁 sourceId，訂單自動過濾
- `oms_order_source`: 移除 ip_whitelist，加 api_token
- 新表: `oms_order_source_device`（員工+設備對應）
- `oms_order`: 加 employee_id, device_id
- `ums_admin`: 加 source_id
- 現有來源 Token:
  - 測試來源: 550711ffb944efb498366a45940f736e
  - claw: 36ae430b6120992e5ac779cd8713342e
  - jay_home: a2ba0a5956d918ce91c5732134f8f8a0

### TASK-005: 假人資料 ✅ (commit `4e2d2a2`)
- `oms_fake_contact` 表: 1 萬筆台灣假人（2~3字中文名 + 09手機）
- SQL 腳本: `document/sql/fake_contacts.sql`
- 代收代付自動帶入隨機假人姓名電話
- 後台可修改: `/order/update/receiverInfo`, `/returnApply/update/returnInfo`

### 待處理
- 阿杰反映 dev.homely-go.com/admin 登入有問題
  - API 測試正常（admin/123456 回 200 + token）
  - 前端頁面有載入（title 正確）
  - Nginx 配置: `/admin/` → alias `/home/ubuntu/mall-admin-web/dist/`
  - API 路徑: `/api/admin/` → proxy 8080
  - 等阿杰回覆具體錯誤症狀

## 理財規劃討論

### 阿杰財務概況
- 39歲，目標40歲退休，月花20萬
- 月薪36萬 + 利息11萬 = 47萬收入
- 月支出15萬（房貸9萬為主）
- 投資：FCN 960萬, 債券360萬, 基金300萬, 股票250萬, 現金200萬
- 總資產 2,070萬
- FCN 標的：TSLA+PLTR, TSLA+TSM, TSLA+AMD（全部有TSLA）
- FCN 結構：60標記/70接（到期觀察）
- 房貸剩29年，無保險

### 關鍵建議
- 40歲全退資金不夠（缺930-1930萬），建議43歲或半退休
- FCN 三張都押 TSLA 風險太集中，下輪分散標的
- 缺保險：需定期壽險（cover房貸）+ 醫療險
- 商城系統產品化（SaaS）可加速退休目標
- 放貸：二胎房貸最安全（有不動產抵押，年化12-18%）

### SaaS 商業模式
- 娛樂城積分商城 SaaS
- 月費 8,000-30,000/租戶
- 10個客戶 = 15萬/月被動收入
- 毛利率 85%+
- 已開始技術改造（Phase 1 完成）
