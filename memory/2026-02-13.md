# 2026-02-13

## General Mall 代收代付改造（延續 02-12）

### TASK-004: Auto-Order API 改造 ✅ (commit `e21314a`)
- IP 白名單 → Token 認證 (`X-Api-Token` header)
- 請求參數: employeeId + deviceId + amount（移除 name/phone）
- 員工/設備歸屬驗證 + Redis 緩存
- 後台: 來源管理加 token 生成/重發、設備 CRUD
- 廠商角色: admin 帳號綁 sourceId，訂單自動過濾

### TASK-005: 假人資料 ✅ (commit `4e2d2a2`)
- `oms_fake_contact` 表: 1 萬筆台灣假人（2~3字中文名 + 09手機）
- 代收代付自動帶入隨機假人姓名電話
- 後台可修改 receiverInfo / returnInfo

### TASK-006: 後台來源管理 UI ✅
- 前端配合 TASK-004 改造
- 移除 IP 白名單，改為 Token 遮罩顯示 + 複製 + 重新生成
- 設備管理 CRUD 對話框（支援批量新增）

## 任務面板 Dashboard ✅ (TASK-007)
- 路徑: `/home/ubuntu/task-dashboard/`
- 訪問: `http://52.76.231.27:3100`
- 功能: Kanban 看板 + Chat + 每日回顧 + workspace 同步
- 技術: Vue 3 + Vite + Express + SQLite
- PM2 管理，port 3100
- Chat 接 OpenClaw hooks (`/hooks/agent`)
- OpenClaw hooks 已啟用，token: `bf6a17123dd96c7ca8f0330cd5c7978f25bfdcd66b894d48`
- 等阿杰給域名再設 Nginx

## 品質保證體系 ✅

### Phase 1: API 自動測試腳本
- TASK-008: General Mall — 26 tests，`/home/ubuntu/general-mall/tests/run-tests.sh`
- TASK-009: Entertainment Mall — 23 tests，`/home/ubuntu/entertainment-mall/tests/run-tests.sh`
- 一鍵執行，PASS/FAIL 輸出，測試資料自動清理

### Phase 2: 前後端相依表
- `workspace/DEPENDENCY-MAP.md`
- 列出兩個商城所有 API ↔ 前端頁面對應關係
- 開工單時檢查規則：改後端必查前端、改前端必查 API

### Phase 1 測試更新 (TASK-010)
- General Mall: 67 tests 全 PASS（商品CRUD、分類、品牌、優惠券、訂單、用戶角色、Portal）
- Entertainment Mall: 41 tests 全 PASS
- run-tests.sh 改為動態載入 test-*.sh
- 踩坑：Brand delete 是 GET 不是 POST、Coupon update 需完整欄位

## Dashboard 修復
- 域名: dashboard.jaysdoit.com（Nginx 已設好，等 DNS A record → 52.76.231.27）
- 修復：啟動時自動同步 workspace tasks + 每 5 分鐘自動掃描
- 之前 tasks 表為空是因為從沒觸發同步
- 10 個任務（TASK-001~010）已全部同步進 dashboard

## TASK-011: 代付只建退貨申請 ✅ (commit `378b125`)
- 移除 generatePayOrder 中建立 oms_order + oms_order_item 的程式碼
- 只保留 oms_order_return_apply（orderId=0）
- 67 tests 全 PASS

## 日誌中文亂碼修復 ✅
- 原因：hutool `JSONUtil.parse().toString()` 會 escape 非 ASCII
- 修法：改為 `JSONUtil.toJsonStr()`，兩個商城都改
- 4 個容器（mall-portal/admin, ent-mall-portal/admin）重建 image 並重啟
- Docker image 是 build jar 進去的（非 volume mount），改 code 要重建 image
- Dockerfile 模板放 /tmp/Dockerfile-portal 等（臨時）

## 通用商城後台 UI 修改

### 退貨詳情頁 (applyDetail.vue)
- 「修改」按鈕改為 el-dialog 彈窗（原本 inline edit 不 work）
- **根本原因**: `currentAddress` computed 回傳 `null`，`formatRegion` filter 讀 `null.province` 拋錯，Vue 組件整個壞掉 → 所有按鈕失效
- 修正: `currentAddress` 找不到回傳 `{}` 而非 `null`，`formatRegion` 加 null 防護
- 移除訂單編號旁的「查看」按鈕
- 訂單編號行高統一（去掉 height:50px）
- 金額優先使用 `returnAmount`（代付訂單金額直接存在此欄位），fallback 才用 `productRealPrice * productCount`

### 退貨列表頁 (apply/index.vue)
- 「用戶帳號」→「退貨人」(returnName) + 新增「手機號碼」(returnPhone)
- 新增「訂單編號」欄 (orderSn)
- 金額同上改用 returnAmount 優先
- **後端修改**: `OmsOrderReturnApplyDao.xml` 的 getList SQL 漏了 `return_phone`，已加上並重建 Docker image

### 訂單列表頁 (order/index.vue)
- 「用戶帳號」→「收貨人」(receiverName) + 新增「手機號碼」(receiverPhone)
- 移除「訂單來源」和「支付方式」欄
- 所有欄位 `width` 改 `min-width` 彈性適應視窗

### Commits
- `dd1c285` 退貨詳情彈窗+移除查看
- `fc4d835` fix currentAddress null
- `7e6d691` 排版修正
- `8cb01b5` 訂單列表改收貨人+手機
- `805a95c` 移除支付方式+調寬度
- `ef156b4` min-width 彈性
- `1a220b8` returnAmount 優先
- `35f330a` 退貨列表加訂單編號
- `48ecd84` 退貨列表改退貨人+手機

## 假人資料調整
- 原本 2字名 ~4900 筆、3字名 ~5100 筆
- 調整為 **2字名 200 筆 (2%)、3字名 9800 筆 (98%)**
- 電話格式不變 (09XX 開頭 10 碼)

## TASK-012: PChome 商品爬取匯入 ✅
- 從 PChome 24h 爬取 7 類商品: 3C數位、家電、食品、生活、居家、保健、美妝
- 每類 80 筆，共 560 筆商品
- 7 個一級分類 + 28 個二級分類
- 289 個品牌（從商品名稱提取）
- 560 張圖片下載到 `/home/ubuntu/product-images/`
- 清空舊商品後全新匯入
- 限制: 只有主圖無相簿圖（PChome API 限制）、品牌從名稱提取不夠精確
- 圖片待上傳 S3

## mall.sql 可移植初始資料整合
- mall.sql 裡的商品資料（品牌、分類、商品、屬性分類、屬性、SKU）全部替換為 PChome 資料
- 使用 `SET @var = (select id ... LIMIT 1)` 風格做 ID 關聯
- SKU: `INSERT INTO pms_sku_stock SELECT id, product_sn, price, 999, 0, 0 FROM pms_product`
- 品牌清理: 289 → 206 個（刪除商品名截斷、描述文字、【】開頭等不合理品牌）
  - 修正: Sea→SEA TO SUMMIT, LENOVO/Lenovo合併, Ogula→Ogula 小倉
  - 128 筆無法辨識品牌歸「其他」
- 最終 commits: `cafb826`(初版), `c4b34c7`(品牌清理)

## 商品種類 (pms_product_attribute_category) ✅
- 7 個種類對應 7 大分類，共 41 個屬性
- 3C數位: 顏色+容量規格 | 品牌+型號+保固+產地
- 家電: 顏色+規格+電壓 | 品牌+功率+保固+產地
- 食品: 口味+包裝 | 品牌+重量+保存期限+產地
- 生活: 顏色+尺寸 | 品牌+材質+產地
- 居家: 顏色+尺寸 | 品牌+材質+產地
- 保健: 規格+口味 | 品牌+成分+適用對象+產地
- 美妝: 色號+容量 | 品牌+膚質+功效+產地
- 待同步到 mall.sql

## TASK-013: 站台帳號自動建立+權限隔離 ✅
- 「來源」全面改名「站台」（前端12處）
- 新增站台自動建立 ums_admin 帳號（username=站台名稱, 隨機8位密碼）
- 自動建立「站台角色」(ums_role)，綁 resource 7(訂單)+8(退貨申請)
- 站台帳號登入只看到訂單列表+退貨申請，且只能看自己站台資料
- 退貨申請加 source 過濾（OmsOrderReturnApplyController.applySourceFilter）
- oms_order_return_apply 加 source_name 欄位，代付API建立時寫入
- XML 過濾改為直接讀 ra.source_name（不再 JOIN oms_order）
- 刪站台連帶清 ums_admin + ums_admin_role_relation
- 前端新增站台後 el-dialog 顯示帳號/密碼/Token（密碼只此一次）
- OmsOrderSourceCreateResult DTO 回傳 source + username + rawPassword
- Commits: 後端 `2d1a9b7`, 前端 `fefad8a`
- 67 tests 全 PASS

## Postman Collection
- `/home/ubuntu/general-mall/postman/Auto-Order-API.postman_collection.json`
- 10 個請求：代收、代付、刷緩存、認證錯誤測試、來源管理、設備管理

## Dashboard 補充
- 註冊 API 已完全關閉（只有 jay 帳號可用）
- 啟動自動同步 + 每 5 分鐘掃描 workspace tasks/

## 代付退貨改造（單筆記錄模式）
- 原本代付建多筆 return_apply（一個商品一筆），改回**一筆 return_apply**
- 多商品明細存在 `product_attr` 欄位（JSON 陣列）
- JSON 格式: `[{productId, productName, productPrice, productCount, returnAmount}, ...]`
- 第一個商品資訊存主欄位（productId, productName 等）
- `returnAmount` = 目標金額（不再拆分）
- `productCount` = 所有商品數量加總
- 前端詳情頁: `orderId===0` 時解析 productAttr JSON 為商品列表
- 前端表格支援雙鍵名: `productPrice` || `productRealPrice`
- `totalAmount` 直接取 `returnAmount`
- `relatedProducts` 欄位已廢棄（不再查同 orderSn 多筆記錄）
- 清理舊資料: 合併 R202602131013071178 和 R202602131037203706 的拆分記錄
- Commits: 後端 `fabaa9f`, 前端 `3676a78`

## 退貨詳情 UI 修復
- 問題描述多行時標頭等高: `type="flex"` + `align-items:center` (commit `1f45ed0`)
- 確認退款金額: 所有狀態都帶入 `returnAmount`（不只 status 1/2）(commit `1e23694`)

## 正式環境保護規則 ✅
- 加入 AGENTS.md
- 未經阿杰指示禁止操作正式環境 DB/Docker/Nginx
- 開發環境可自由操作
- 分不清環境一律當正式環境處理

## TASK-014: 全台 7-11 門市爬取 ✅
- 來源: emap.pcsc.com.tw EMapSDK API
- 爬取方式: GetTown 取區域 → SearchStore 取門市（per 區域）
- GetCity API 回空，改用硬編碼 22 縣市
- 結果: **7,316 家門市**，22 縣市全覆蓋
- 資料: store_id, store_name, city, district, address, phone, longitude, latitude, services, op_time
- 表: `store_711` (mall DB)
- 檔案: `/home/ubuntu/7eleven-scraper/stores.json` + `7eleven_stores.sql`
- 分佈: 新北 1220, 台北 967, 台中 923, 桃園 849, 高雄 754, 台南 607...

## TASK-015: 假人關聯 7-11 門市 ✅
- `oms_fake_contact` 新增 `store_id` 欄位（FK → store_711.store_id）
- 10,000 假人按台灣人口比例分配到 7-11 門市
  - 新北 1703, 台中 1202, 高雄 1182, 台北 1082, 桃園 982, 台南 802...
- Mapper 新增 `selectRandomWithStore()` — JOIN store_711 一次取出假人+門市資訊
- OmsFakeContact 加 transient 欄位: storeName, storeCity, storeDistrict, storeAddress, storePhone
- 代收訂單自動帶入:
  - receiver_province = 縣市, receiver_city = 區域
  - receiver_detail_address = "7-11 {門市名} ({地址})"
- 代付改用 selectRandomWithStore()（退貨申請表暫無地址欄位）
- **附帶修正**: `oms_order_return_apply.product_attr` 從 VARCHAR(500) 改 TEXT（多商品 JSON 會超長）
- 分配腳本: `/home/ubuntu/7eleven-scraper/assign_stores.py`
- 注意: 本地測試 source token 沒綁 device，測試要用 claw source token

## TASK-016: 訂單列表時間篩選+導出Excel ✅
- 提交時間: 單日 → 日期區間 (startTime/endTime)
- OmsOrderQueryParam: 移除 createTime，新增 startTime/endTime
- OmsOrderDao.xml: createTime LIKE → startTime/endTime 區間查詢
- 導出 API: `/order/exportExcel` (GET, hutool ExcelWriter)
  - 驗證: 至少一個篩選條件，日期不超過 31 天
  - 欄位: 訂單編號、提交時間、收貨人、手機、訂單金額、應付金額、站台、狀態、地址、商品明細
  - 商品明細: 查 oms_order_item，格式「商品名 × 數量」
  - listAll(): 不用 PageHelper 的全量查詢
- 前端: daterange picker + 導出按鈕 + axios blob 下載
- request.js interceptor 加 blob responseType 判斷
- 踩坑: poi-ooxml 5.2.5 與 commons-compress 衝突，用 4.1.2
- Commits: 後端 `9c206b6`(含), 前端已 push

## receiverRegion null 修復
- 代收建單時沒設 receiverRegion，前端拼接地址出現 null
- 修正: `order.setReceiverRegion("")` (commit `8cec536`)
- 舊訂單的 null 還在，可批次 UPDATE 清掉

## TASK-018: 退貨申請導出 Excel ✅
- 同訂單列表導出模式（TASK-016）
- 後端: `/returnApply/exportExcel` API, OmsReturnApplyQueryParam 改 startTime/endTime
- XML 補充 product_name/product_attr 欄位
- 商品明細: 代付解析 productAttr JSON，一般退貨用 productName × productCount
- Commits: 後端 `0296a7c`, 前端 `778bd8b`

## Redis 配置縮排事故 ⚠️
- TASK-017 移除 MongoDB 時把 `spring.data.mongodb` 段落刪除
- 導致 `spring.data.redis:` 下面的 host/port 等屬性縮排壞掉（跟 `redis:` 同層而非子層）
- Spring 讀不到 redis host，fallback 到 localhost:6379 → portal 503
- 修正: `spring.data.redis:` 改為 `spring.redis:` 並修正縮排
- application-dev.yml 和 application-prod.yml 都有問題，都修了
- Commit: `3fc0c5a`
- **教訓**: 改 YAML 後必須驗證縮排（已加入 AGENTS.md）

## TASK-017: 移除 MongoDB ✅
- 移除 15 個 Java 檔（Controller/Service/Repository/Domain）
- 排除 MongoAutoConfiguration, 移除 yml/pom/docker-compose 的 mongo 配置
- 停止並移除 mall-mongo 容器
- 啟動加速 31%: 22.6s → 15.5s
- 代收代付 API 正常

## TASK-018: 退貨申請導出 Excel（進行中）
- 同訂單列表導出模式
- 申請時間改日期區間 (startTime/endTime)
- 導出欄位: 服務單號、訂單編號、申請時間、退貨人、手機、退款金額、狀態、原因、描述、商品明細
- 商品明細: 代付解析 productAttr JSON，一般退貨用 productName × productCount

## 訂單詳情付款狀態修復
- 操作記錄表的「付款狀態」用 scope.row.orderStatus 判斷（每筆記錄當時狀態）
- formatPayStatus: status 0/4 → 未支付，其餘 → 已支付（移除「已退款」）
- 清理 20 筆「訂單關閉」測試髒資料（oms_order_operate_history）

## 退貨詳情合計修復
- totalAmount 改為商品合計（productList 每項 price × count 加總）
- 不再用 returnAmount（那是退款金額）

## 代付問題描述換行
- 後端: 商品間用 `\n` 分隔（原本用 `; `）
- 前端: 問題描述欄加 `white-space: pre-wrap`
- Commits: 後端 `29c3fb8`, 前端 `d03c90d`

## TASK-019: 修復+補充 API 測試 ✅
- 修復 test-source-mgmt.sh（加 adminUsername/adminPassword 參數）
- 修復 test-device-mgmt.sh
- 補充 test-auto-order.sh（代收門市地址驗證、代付單筆退貨驗證）
- 新增 test-export.sh（5 項導出 Excel 測試）
- 新增 test-store711.sh（3 項 7-11 門市+假人關聯驗證）
- 最終: **78 PASS / 0 FAIL**

## 代收代付 API 新增四個可選參數 (commit `67a6113`)
- **phone**: 帶入→新增一筆到 oms_fake_contact + 使用該電話; 不帶→隨機假人
- **address**: 帶入→覆蓋 receiverDetailAddress; 不帶→用門市地址
- **remark**: 備註，代收存 order.note，代付附加到 description
- **notes**: 附註，同上
- AutoOrderRequest.java 加 4 個欄位
- OmsFakeContactMapper 加 insert 方法
- AutoOrderServiceImpl 代收+代付都處理了這 4 個參數

## MyBatis 駝峰映射 bug (commit `ecc2e0c`)
- general-mall 沒有開 `mapUnderscoreToCamelCase`
- `selectRandomWithStore` 用 `fc.*` 導致 `store_id` 映射不到 `storeId`
- 修正: 改用明確 alias `fc.store_id as storeId`
- **教訓**: 沒開駝峰映射時，所有 @Select 的 underscore 欄位都要手動 alias

## Excel 導出商品明細換行 (commit `38d5d9f`)
- 訂單+退貨申請導出都加了 CellStyle wrapText
- 商品明細欄+問題描述欄自動換行

## 日期區間選擇器寬度 (commit `db060f0`)
- 訂單+退貨申請列表的 daterange picker 從 280px 改 340px
- 「至」字仍有顯示問題，待後續處理

## 已歸檔任務
- TASK-001~005 在 archive/
- TASK-006~011 在 tasks/（有 DONE.md，待歸檔）
