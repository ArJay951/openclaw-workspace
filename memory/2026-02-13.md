# 2026-02-13

## General Mall 代收代付改造（延續 02-12）

### TASK-004: Auto-Order API 改造 ✅ (commit `e21314a`)
- IP 白名單 → Token 認證 (`X-Api-Token` header)
- 請求參數: employeeId + deviceId + amount（移除 name/phone）
- 員工/設備歸屬驗證 + Redis 緩存
- 後台: 來源管理加 token 生成/重發、設備 CRUD
- 廠商角色: admin 帳號綁 sourceId，訂單自動過濾

### TASK-005: 假人資料 ✅ (commit `4e2d2a2`)
- `oms_fake_contact` 表: 1 萬筆台灣假人（2~3字中文名 + 09手機）
- 代收代付自動帶入隨機假人姓名電話
- 後台可修改 receiverInfo / returnInfo

### TASK-006: 後台來源管理 UI ✅
- 前端配合 TASK-004 改造
- 移除 IP 白名單，改為 Token 遮罩顯示 + 複製 + 重新生成
- 設備管理 CRUD 對話框（支援批量新增）

## 任務面板 Dashboard ✅ (TASK-007)
- 路徑: `/home/ubuntu/task-dashboard/`
- 訪問: `http://52.76.231.27:3100`
- 功能: Kanban 看板 + Chat + 每日回顧 + workspace 同步
- 技術: Vue 3 + Vite + Express + SQLite
- PM2 管理，port 3100
- Chat 接 OpenClaw hooks (`/hooks/agent`)
- OpenClaw hooks 已啟用，token: `bf6a17123dd96c7ca8f0330cd5c7978f25bfdcd66b894d48`
- 等阿杰給域名再設 Nginx

## 品質保證體系 ✅

### Phase 1: API 自動測試腳本
- TASK-008: General Mall — 26 tests，`/home/ubuntu/general-mall/tests/run-tests.sh`
- TASK-009: Entertainment Mall — 23 tests，`/home/ubuntu/entertainment-mall/tests/run-tests.sh`
- 一鍵執行，PASS/FAIL 輸出，測試資料自動清理

### Phase 2: 前後端相依表
- `workspace/DEPENDENCY-MAP.md`
- 列出兩個商城所有 API ↔ 前端頁面對應關係
- 開工單時檢查規則：改後端必查前端、改前端必查 API

### Phase 1 測試更新 (TASK-010)
- General Mall: 67 tests 全 PASS（商品CRUD、分類、品牌、優惠券、訂單、用戶角色、Portal）
- Entertainment Mall: 41 tests 全 PASS
- run-tests.sh 改為動態載入 test-*.sh
- 踩坑：Brand delete 是 GET 不是 POST、Coupon update 需完整欄位

## Dashboard 修復
- 域名: dashboard.jaysdoit.com（Nginx 已設好，等 DNS A record → 52.76.231.27）
- 修復：啟動時自動同步 workspace tasks + 每 5 分鐘自動掃描
- 之前 tasks 表為空是因為從沒觸發同步
- 10 個任務（TASK-001~010）已全部同步進 dashboard

## TASK-011: 代付只建退貨申請 ✅ (commit `378b125`)
- 移除 generatePayOrder 中建立 oms_order + oms_order_item 的程式碼
- 只保留 oms_order_return_apply（orderId=0）
- 67 tests 全 PASS

## 日誌中文亂碼修復 ✅
- 原因：hutool `JSONUtil.parse().toString()` 會 escape 非 ASCII
- 修法：改為 `JSONUtil.toJsonStr()`，兩個商城都改
- 4 個容器（mall-portal/admin, ent-mall-portal/admin）重建 image 並重啟
- Docker image 是 build jar 進去的（非 volume mount），改 code 要重建 image
- Dockerfile 模板放 /tmp/Dockerfile-portal 等（臨時）

## 通用商城後台 UI 修改

### 退貨詳情頁 (applyDetail.vue)
- 「修改」按鈕改為 el-dialog 彈窗（原本 inline edit 不 work）
- **根本原因**: `currentAddress` computed 回傳 `null`，`formatRegion` filter 讀 `null.province` 拋錯，Vue 組件整個壞掉 → 所有按鈕失效
- 修正: `currentAddress` 找不到回傳 `{}` 而非 `null`，`formatRegion` 加 null 防護
- 移除訂單編號旁的「查看」按鈕
- 訂單編號行高統一（去掉 height:50px）
- 金額優先使用 `returnAmount`（代付訂單金額直接存在此欄位），fallback 才用 `productRealPrice * productCount`

### 退貨列表頁 (apply/index.vue)
- 「用戶帳號」→「退貨人」(returnName) + 新增「手機號碼」(returnPhone)
- 新增「訂單編號」欄 (orderSn)
- 金額同上改用 returnAmount 優先
- **後端修改**: `OmsOrderReturnApplyDao.xml` 的 getList SQL 漏了 `return_phone`，已加上並重建 Docker image

### 訂單列表頁 (order/index.vue)
- 「用戶帳號」→「收貨人」(receiverName) + 新增「手機號碼」(receiverPhone)
- 移除「訂單來源」和「支付方式」欄
- 所有欄位 `width` 改 `min-width` 彈性適應視窗

### Commits
- `dd1c285` 退貨詳情彈窗+移除查看
- `fc4d835` fix currentAddress null
- `7e6d691` 排版修正
- `8cb01b5` 訂單列表改收貨人+手機
- `805a95c` 移除支付方式+調寬度
- `ef156b4` min-width 彈性
- `1a220b8` returnAmount 優先
- `35f330a` 退貨列表加訂單編號
- `48ecd84` 退貨列表改退貨人+手機

## 假人資料調整
- 原本 2字名 ~4900 筆、3字名 ~5100 筆
- 調整為 **2字名 200 筆 (2%)、3字名 9800 筆 (98%)**
- 電話格式不變 (09XX 開頭 10 碼)

## TASK-012: PChome 商品爬取匯入 ✅
- 從 PChome 24h 爬取 7 類商品: 3C數位、家電、食品、生活、居家、保健、美妝
- 每類 80 筆，共 560 筆商品
- 7 個一級分類 + 28 個二級分類
- 289 個品牌（從商品名稱提取）
- 560 張圖片下載到 `/home/ubuntu/product-images/`
- 清空舊商品後全新匯入
- 限制: 只有主圖無相簿圖（PChome API 限制）、品牌從名稱提取不夠精確
- 圖片待上傳 S3

## mall.sql 可移植初始資料整合
- mall.sql 裡的商品資料（品牌、分類、商品、屬性分類、屬性、SKU）全部替換為 PChome 資料
- 使用 `SET @var = (select id ... LIMIT 1)` 風格做 ID 關聯
- SKU: `INSERT INTO pms_sku_stock SELECT id, product_sn, price, 999, 0, 0 FROM pms_product`
- 品牌清理: 289 → 206 個（刪除商品名截斷、描述文字、【】開頭等不合理品牌）
  - 修正: Sea→SEA TO SUMMIT, LENOVO/Lenovo合併, Ogula→Ogula 小倉
  - 128 筆無法辨識品牌歸「其他」
- 最終 commits: `cafb826`(初版), `c4b34c7`(品牌清理)

## 商品種類 (pms_product_attribute_category) ✅
- 7 個種類對應 7 大分類，共 41 個屬性
- 3C數位: 顏色+容量規格 | 品牌+型號+保固+產地
- 家電: 顏色+規格+電壓 | 品牌+功率+保固+產地
- 食品: 口味+包裝 | 品牌+重量+保存期限+產地
- 生活: 顏色+尺寸 | 品牌+材質+產地
- 居家: 顏色+尺寸 | 品牌+材質+產地
- 保健: 規格+口味 | 品牌+成分+適用對象+產地
- 美妝: 色號+容量 | 品牌+膚質+功效+產地
- 待同步到 mall.sql

## TASK-013: 站台帳號自動建立+權限隔離 ✅
- 「來源」全面改名「站台」（前端12處）
- 新增站台自動建立 ums_admin 帳號（username=站台名稱, 隨機8位密碼）
- 自動建立「站台角色」(ums_role)，綁 resource 7(訂單)+8(退貨申請)
- 站台帳號登入只看到訂單列表+退貨申請，且只能看自己站台資料
- 退貨申請加 source 過濾（OmsOrderReturnApplyController.applySourceFilter）
- oms_order_return_apply 加 source_name 欄位，代付API建立時寫入
- XML 過濾改為直接讀 ra.source_name（不再 JOIN oms_order）
- 刪站台連帶清 ums_admin + ums_admin_role_relation
- 前端新增站台後 el-dialog 顯示帳號/密碼/Token（密碼只此一次）
- OmsOrderSourceCreateResult DTO 回傳 source + username + rawPassword
- Commits: 後端 `2d1a9b7`, 前端 `fefad8a`
- 67 tests 全 PASS

## Postman Collection
- `/home/ubuntu/general-mall/postman/Auto-Order-API.postman_collection.json`
- 10 個請求：代收、代付、刷緩存、認證錯誤測試、來源管理、設備管理

## Dashboard 補充
- 註冊 API 已完全關閉（只有 jay 帳號可用）
- 啟動自動同步 + 每 5 分鐘掃描 workspace tasks/

## 已歸檔任務
- TASK-001~005 在 archive/
- TASK-006~011 在 tasks/（有 DONE.md，待歸檔）
